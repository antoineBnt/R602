<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Drag Baguettes (A-Frame Extras VR)</title>

    <!-- A-Frame principal -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

    <!-- A-Frame Extras (dragndrop + movement-controls + gamepad) -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/aframe-extras.min.js"></script>
    <!-- Assure-toi que la version inclut bien le "movement-controls" -->
  </head>
  <body>
    <a-scene
      fog="type: linear; color: #244060; near: 0.5; far: 25"
      vr-mode-ui="enabled: true"
    >
      <!-- 1) ASSETS -->
      <a-assets>
        <!-- Modèles 3D -->
        <a-asset-item
          id="batterieModel"
          src="assets/batterie.glb"
        ></a-asset-item>
        <a-asset-item
          id="baguettesModel"
          src="assets/baguette.glb"
        ></a-asset-item>
        <a-asset-item
          id="projecteur"
          src="assets/projecteur.glb"
        ></a-asset-item>
        <a-asset-item id="sol" src="assets/sol.glb"></a-asset-item>

        <!-- Son d'océan -->
        <audio
          id="oceanSnd"
          src="assets/ocean-sound.mp3"
          preload="auto"
        ></audio>
      </a-assets>

      <!-- 2) OCÉAN AVEC SON -->
      <a-ocean
        id="ocean"
        width="500"
        depth="500"
        density="400"
        opacity="1"
        position="0 -0.4 0"
        material="shader: standard; color: #182264; roughness: 1"
        sound="src: #oceanSnd; autoplay: true; loop: true; positional: true; volume: 0.8"
      ></a-ocean>

      <!-- 3) PROJECTEURS, OBJETS, ETC. -->
      <!-- Sol 3D -->
      <a-entity
        gltf-model="#sol"
        position="0 -1 10"
        scale="2 2 2"
        rotation="0 90 0"
      ></a-entity>

      <!-- Plan au sol de base, si besoin -->
      <a-entity
        geometry="primitive: plane; width: 100; height: 100"
        material="color: #1D2A80"
        rotation="-90 0 0"
      ></a-entity>

      <!-- Batterie (cliquable) -->
      <a-entity
        id="drum"
        gltf-model="#batterieModel"
        position="0 1.5 -5"
        class="clickable"
      ></a-entity>

      <!-- Baguette gauche -->
      <a-entity
        id="baguetteLeft"
        visible="false"
        material="opacity: 0; transparent: true"
        position="0.2 1.8 -5"
        scale="2 2 2"
      >
        <a-entity gltf-model="#baguettesModel"></a-entity>
        <a-entity
          class="draggable"
          dragndrop
          geometry="primitive: box; width: 0.15; height: 0.5; depth: 0.15"
          material="opacity: 0; wireframe: true; transparent: true"
        ></a-entity>
      </a-entity>

      <!-- Baguette droite -->
      <a-entity
        id="baguetteRight"
        visible="false"
        material="opacity: 0; transparent: true"
        position="-0.2 1.8 -5"
        scale="2 2 2"
      >
        <a-entity gltf-model="#baguettesModel"></a-entity>
        <a-entity
          class="draggable"
          dragndrop
          geometry="primitive: box; width: 0.15; height: 0.5; depth: 0.15"
          material="opacity: 0; wireframe: true; transparent: true"
        ></a-entity>
      </a-entity>

      <!-- Projecteur 1 + spot + sphère blanche -->
      <a-entity
        id="projecteur1"
        gltf-model="#projecteur"
        position="0 8 0"
        rotation="-40 0 0"
      >
        <a-light
          type="spot"
          color="#ffffff"
          intensity="1.5"
          position="0 0 0"
          target="#drum"
          angle="30"
          penumbra="0.5"
        ></a-light>

        <a-entity
          geometry="primitive: sphere; radius: 0.25"
          material="color: white; emissive: white; emissiveIntensity: 1; opacity: 0.8"
          position="0 -0.9 -0.2"
          light="type: point; color: #FFFFFF; intensity: 2; distance: 1"
        ></a-entity>
      </a-entity>

      <!-- Projecteur 2 + spot + sphère blanche -->
      <a-entity
        id="projecteur2"
        gltf-model="#projecteur"
        position="-3 8 -2"
        rotation="-45 -20 0"
      >
        <a-light
          type="spot"
          color="#ffffff"
          intensity="1.5"
          position="0 0 0"
          target="#drum"
          angle="30"
          penumbra="0.5"
        ></a-light>

        <a-entity
          geometry="primitive: sphere; radius: 0.25"
          material="color: white; emissive: white; emissiveIntensity: 1; opacity: 0.8"
          position="0 -0.9 -0.2"
          light="type: point; color: #FFFFFF; intensity: 2; distance: 1"
        ></a-entity>
      </a-entity>

      <!-- Projecteur 3 + spot + sphère blanche -->
      <a-entity
        id="projecteur3"
        gltf-model="#projecteur"
        position="3 8 -2"
        rotation="-45 20 0"
      >
        <a-light
          type="spot"
          color="#ffffff"
          intensity="0.5"
          position="0 0 0"
          target="#drum"
          angle="10"
          penumbra="0.1"
        ></a-light>

        <a-entity
          geometry="primitive: sphere; radius: 0.25"
          material="color: white; emissive: white; emissiveIntensity: 1; opacity: 0.8"
          position="0 -0.9 -0.2"
          light="type: point; color: #FFFFFF; intensity: 2; distance: 1"
        ></a-entity>
      </a-entity>

      <!-- Lumière supplémentaire qui tourne (votre code existant) -->
      <a-entity
        light="color: #FFFFFF; target: #ocean; intensity: 0.07;"
        position="0 20 0"
        animation="property: rotation; to: 0 -360 0; loop: true; dur: 20000; easing: linear"
      ></a-entity>

      <!-- 4) LE RIG + CAMÉRA + CONTRÔLEURS VR -->
      <!-- Le rig (gère la locomotion VR) -->
      <a-entity id="playerRig" movement-controls="speed: 0.1" position="0 0 0">
        <!-- Caméra (hauteur d’environ 1.6m) -->
        <a-entity
          id="playerCam"
          camera
          position="0 1.6 0"
          look-controls="pointerLockEnabled: false"
        ></a-entity>

        <!-- Main gauche (joystick) -->
        <a-entity
          id="leftHand"
          oculus-touch-controls="hand: left"
          gamepad-controls="hand: left"
        ></a-entity>

        <!-- Main droite (laser + clic) -->
        <a-entity
          id="rightHand"
          oculus-touch-controls="hand: right"
          gamepad-controls="hand: right"
          laser-controls
          raycaster="objects: .clickable, .draggable; showLine: true"
          line="color: white; opacity: 0.8"
        ></a-entity>
      </a-entity>

      <!-- 5) Ciel (non affecté par le brouillard) -->
      <a-sky src="assets/sky.jpg" material="fog: false"></a-sky>
    </a-scene>

    <!-- 6) SCRIPT PRINCIPAL -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const drumEl = document.getElementById("drum");
        const playerRigEl = document.getElementById("playerRig");
        const leftStickEl = document.getElementById("baguetteLeft");
        const rightStickEl = document.getElementById("baguetteRight");

        let isSeated = false;

        // -- Clic sur la batterie -> s'asseoir --
        drumEl.addEventListener("click", () => {
          if (isSeated) return;
          isSeated = true;

          // On déplace le RIG (caméra + contrôleurs) vers la batterie
          playerRigEl.setAttribute("animation__rigpos", {
            property: "position",
            to: { x: 0, y: 0, z: -4.4 }, // Ajuster pour être devant la batterie
            dur: 1000,
            easing: "easeInOutQuad",
            startEvents: "startMove",
          });
          // On oriente éventuellement le rig (si besoin)
          playerRigEl.setAttribute("animation__rigrot", {
            property: "rotation",
            to: { x: 0, y: 180, z: 0 },
            dur: 1000,
            easing: "easeInOutQuad",
            startEvents: "startMove",
          });

          // Déclenche l'animation
          playerRigEl.emit("startMove");

          // Apparition des baguettes
          leftStickEl.setAttribute("visible", true);
          leftStickEl.setAttribute("animation__fadein_left", {
            property: "material.opacity",
            from: 0,
            to: 1,
            dur: 800,
            easing: "easeInOutQuad",
          });

          rightStickEl.setAttribute("visible", true);
          rightStickEl.setAttribute("animation__fadein_right", {
            property: "material.opacity",
            from: 0,
            to: 1,
            dur: 800,
            easing: "easeInOutQuad",
          });
        });

        // -- Espace -> se relever (pour usage desktop) --
        // En VR, vous pouvez rajouter un autre bouton si nécessaire
        document.body.addEventListener("keyup", (evt) => {
          if (evt.code === "Space" && isSeated) {
            isSeated = false;

            // Stop animations
            playerRigEl.removeAttribute("animation__rigpos");
            playerRigEl.removeAttribute("animation__rigrot");

            // Remet le rig à sa position/rotation initiale
            playerRigEl.setAttribute("position", { x: 0, y: 0, z: 0 });
            playerRigEl.setAttribute("rotation", { x: 0, y: 0, z: 0 });

            // Masquer baguettes
            leftStickEl.setAttribute("animation__fadeout_left", {
              property: "material.opacity",
              from: 1,
              to: 0,
              dur: 600,
              easing: "easeInOutQuad",
              startEvents: "hideLeft",
            });
            rightStickEl.setAttribute("animation__fadeout_right", {
              property: "material.opacity",
              from: 1,
              to: 0,
              dur: 600,
              easing: "easeInOutQuad",
              startEvents: "hideRight",
            });

            leftStickEl.addEventListener(
              "animationcomplete__fadeout_left",
              () => {
                leftStickEl.setAttribute("visible", false);
              },
              { once: true }
            );
            rightStickEl.addEventListener(
              "animationcomplete__fadeout_right",
              () => {
                rightStickEl.setAttribute("visible", false);
              },
              { once: true }
            );

            leftStickEl.emit("hideLeft");
            rightStickEl.emit("hideRight");
          }
        });
      });
    </script>
  </body>
</html>
